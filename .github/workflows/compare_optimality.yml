name: Verify Optimal Tree Correctness

on:
  pull_request:
    branches: [ "main" ]

jobs:
  verify-correctness:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential python3

      - name: Build Code
        run: |
          # Find the main.cpp file to locate the code directory
          # This ensures it works even if folder names change
          CODE_DIR=$(find . -type f -name "main.cpp" -exec dirname {} \; | head -n 1)
          cd "$CODE_DIR"
          
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

      - name: Run Verification Script
        run: |
          # 1. Find the compiled executable
          CODE_DIR=$(find . -type f -name "main.cpp" -exec dirname {} \; | head -n 1)
          EXECUTABLE="$CODE_DIR/build/ConTree"
          
          # 2. Find the verification python script
          SCRIPT_PATH="$CODE_DIR/Utilities/verify_optimality.py"
          
          # 3. Find the baseline results file
          BASELINE_PATH=$(find . -maxdepth 4 -name "baseline_results.txt" | head -n 1)

          # Safety Checks
          if [ ! -f "$EXECUTABLE" ]; then
             echo "::error::Executable not found at $EXECUTABLE"
             exit 1
          fi

          if [ -z "$BASELINE_PATH" ]; then
            echo "::error::Could not find baseline_results.txt in the repository!"
            exit 1
          fi

          echo "Running verification..."
          echo "Executable: $EXECUTABLE"
          echo "Baseline:   $BASELINE_PATH"
          
          # Run the script (Depth limits are handled inside verify_optimality.py)
          python3 "$SCRIPT_PATH" --executable "$EXECUTABLE" --baseline "$BASELINE_PATH"
