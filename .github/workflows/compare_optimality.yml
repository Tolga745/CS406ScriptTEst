name: Compare Tree Optimality

on:
  pull_request:
    branches: [ "main" ]

jobs:
  benchmark-optimality:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the code from the Pull Request (The new parallel implementation)
      - name: Checkout PR Branch
        uses: actions/checkout@v3
        with:
          path: pr_branch

      # 2. Checkout the code from the Main Branch (The baseline)
      - name: Checkout Main Branch
        uses: actions/checkout@v3
        with:
          ref: main
          path: main_branch

      # 3. Install CMake and Build Tools
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      # 4. Build the Main Branch Version
      - name: Build Main Branch
        run: |
          # Go into the 'contree/code' folder inside the main branch checkout
          cd main_branch/contree/code
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

      # 5. Run Main Branch and Capture Score
      - name: Run Main Branch Benchmark
        id: run_main
        run: |
          cd main_branch/contree/code/build
          
          # Path to datasets: ../../datasets/bank.txt
          # (Up 1 to 'code', Up 2 to 'contree', then into 'datasets')
          echo "Running Main Branch implementation..."
          ./ConTree -file ../../datasets/bank.txt -max-depth 3 -time 30 > output.txt
          
          cat output.txt
          SCORE=$(grep "Misclassification score:" output.txt | awk '{print $3}')
          echo "Main Branch Score: $SCORE"
          echo "main_score=$SCORE" >> $GITHUB_OUTPUT

      # 6. Build the PR Branch Version
      - name: Build PR Branch
        run: |
          # Go into the 'contree/code' folder inside the PR branch checkout
          cd pr_branch/contree/code
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

      # 7. Run PR Branch and Capture Score
      - name: Run PR Branch Benchmark
        id: run_pr
        run: |
          cd pr_branch/contree/code/build

          export OMP_NUM_THREADS=4
          echo "Running PR Branch (Parallel) implementation..."
          ./ConTree -file ../../datasets/bank.txt -max-depth 3 -time 30 > output.txt
          
          cat output.txt
          SCORE=$(grep "Misclassification score:" output.txt | awk '{print $3}')
          echo "PR Branch Score: $SCORE"
          echo "pr_score=$SCORE" >> $GITHUB_OUTPUT

      # 8. Compare Results
      - name: Compare Optimality
        run: |
          MAIN_SCORE=${{ steps.run_main.outputs.main_score }}
          PR_SCORE=${{ steps.run_pr.outputs.pr_score }}

          echo "----------------------------------------"
          echo "Baseline (Main) Misclassification Score: $MAIN_SCORE"
          echo "New (PR) Misclassification Score:        $PR_SCORE"
          echo "----------------------------------------"

          if [ "$PR_SCORE" -lt "$MAIN_SCORE" ]; then
            echo "✅ SUCCESS: The new implementation found a MORE optimal tree!"
          elif [ "$PR_SCORE" -eq "$MAIN_SCORE" ]; then
            echo "✅ NEUTRAL: The new implementation found an EQUALLY optimal tree."
          else
            echo "❌ FAILURE: The new implementation found a LESS optimal (worse) tree."
            exit 1
          fi
