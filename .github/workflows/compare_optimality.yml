name: Verify Optimal Tree Correctness

on:
  pull_request:
    branches: [ "main" ]

jobs:
  verify-correctness:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential python3

      - name: Build Code
        run: |
          # Robustly find the directory containing the REAL main.cpp
          # We exclude 'build' and 'CMakeFiles' to avoid finding temporary test files
          CODE_DIR=$(find . -name "main.cpp" -not -path "*/build/*" -not -path "*/CMakeFiles/*" -exec dirname {} \; | head -n 1)
          
          echo "Found source code directory: $CODE_DIR"
          cd "$CODE_DIR"
          
          # Clean build setup
          rm -rf build
          mkdir build
          cd build
          
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

      - name: Run Verification Script
        run: |
          # 1. Find the code directory again using the same safe logic
          CODE_DIR=$(find . -name "main.cpp" -not -path "*/build/*" -not -path "*/CMakeFiles/*" -exec dirname {} \; | head -n 1)
          
          # 2. Construct path to the executable we just built
          EXECUTABLE="$CODE_DIR/build/ConTree"
          
          # 3. Find the python script
          SCRIPT_PATH="$CODE_DIR/Utilities/verify_optimality.py"
          
          # 4. Find the baseline file
          BASELINE_PATH=$(find . -name "baseline_results.txt" -not -path "*/build/*" | head -n 1)

          # Debugging Prints
          echo "----------------------------------------"
          echo "Source Dir: $CODE_DIR"
          echo "Executable: $EXECUTABLE"
          echo "Script:     $SCRIPT_PATH"
          echo "Baseline:   $BASELINE_PATH"
          echo "----------------------------------------"

          # Safety Checks
          if [ ! -f "$EXECUTABLE" ]; then
             echo "::error::Executable not found at $EXECUTABLE"
             # Fallback check: list the build dir to see where it went
             ls -R "$CODE_DIR/build"
             exit 1
          fi

          if [ -z "$BASELINE_PATH" ]; then
            echo "::error::Could not find baseline_results.txt in the repository!"
            exit 1
          fi

          # Run the verification
          python3 "$SCRIPT_PATH" --executable "$EXECUTABLE" --baseline "$BASELINE_PATH"
